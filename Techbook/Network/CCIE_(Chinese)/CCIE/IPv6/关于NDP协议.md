# 关于NDP协议

关于NDP协议

2011年6月27日

16:56

**关于NDP协议（Neighbor Discovery Protocol）邻居发现协议**

**IPv6除了增大了地址空间以外，可以说NDP协议是最有特色的了，IPv6的很多优势都是通过NDP来完成的**

**IPv6协议除了它显著的增加地址空间外，一个最显著的特征就是它的即插即用特性，邻居发现协议就是使用以下的功能来实现这些即插即用特性的协议：**

**口诀：NDP 9功能，5消息**

**NDP可以实现下面功能：**

**1.Router Discovery（路由器发现）：节点可以发现路由器的功能。当一个节点连接到一个IPv6的链路上时，它能够发现本地的路由器，而不必借助动态主机配置协议（DHCP）**

**2.Prefix Discovery（前缀发现）：节点可以发现路由前缀。当一个节点连接到一个IPv6的链路上时，能够发现分配给该链路的前缀**

**3.Parameter Discovery（参数发现）：节点可以发现一些参数，如链路MTU、跳数限制等等**

**4.Address Autoconfiguration（地址自动配置）：节点能够确定它的完整地址，同样也不需要DHCP的分配**

**5.Address Resolution（地址解析）：节点可以解析链路层地址，不需要ARP的解析 //没有广播，自然就不能使用ARP协议**

**6.Next-hop Determination（下一跳确定）：节点可以确定下一跳链路层地址**

**7.Neighbor Unreachability Detection（邻居不可达检测）：节点可以检测到本链路的邻居不可达了，可以是主机也可以是路由器**

**8.Duplicate Address Detection（重复地址检测）：检测是否有重复地址，类似于IPv4中的无故ARP**

**9.Redirect（重定向）：重定向功能。对于非连接的目的节点，路由器能够通过重定向消息通知主机存在比它自己更好的下一跳路由。该重定向功能在IPv4协议中是ICMP基本功能的一部分，但是在IPv6协议里被重新定义为NDP协议的一部分。**

**其中第4条是最有特色的，也叫做无状态自动配置**

**注意：**

**（1）NDP消息仅在本链路范围内有效**

**（2）NDP消息是封装在本地链路地址中的，或者是在组播地址中，且这个组播地址的范围是链路本地**

**（3）NDP消息的Hop Limit默认是255，如果一台路由器收到的NDP消息的Hop Limit小于255，则丢弃该数据报，原因是该路由器认为这个NDP消息跨网段了**

**通过抓包可以看到：**

**查询MAC地址不再是通过ARP广播的方式请求了，而是采用组播发送请求的方式，等待对方的回应。其中使用组播的意义和方式在IGP中已经说过，就是由于组播IP会生成对应的组播MAC被网卡监听，如果网卡比对收到的数据包目的mac地址和自己监听的组播mac地址相同，才会交给操作系统继续处理。**

**关于NDP的五个消息**

**1.路由器请求（Router Solicitation（RS，type=133，code=0））：主机发送，用于请求RA消息**

**2.路由器通告（Router Advertisement（RA，type=134，code=0））：路由器发送，用于通告自身的存在和一些参数，如链路前缀，MTU和hop limits。两种发送方式：定期发送，或者是回应RS消息**

**3.邻居请求（Neighbor Solicitation（NS，type=135，code=0））：节点发送，用于请求另一个节点的链路层地址，其他功能是用于复制地址检测，和邻居不可达检测**

**4.邻居通告（Neighbor Advertisement（NA，type=136，code=0））：节点发送，用于响应NS消息。如果一个节点的链路层地址改变了，他会发送NA消息通告新地址**

**5.重定向（Redirect（type=137，code=0））：和IPv4中的重定向是一个作用**