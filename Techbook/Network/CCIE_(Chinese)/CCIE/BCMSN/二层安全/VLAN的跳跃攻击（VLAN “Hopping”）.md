# VLAN的跳跃攻击（VLAN “Hopping”）

VLAN的跳跃攻击（VLAN “Hopping”）

2011年7月7日

15:02

针对于VLAN的跳跃攻击（VLAN “Hopping”）

![VLAN%E7%9A%84%E8%B7%B3%E8%B7%83%E6%94%BB%E5%87%BB%EF%BC%88VLAN%20%E2%80%9CHopping%E2%80%9D%EF%BC%89%202dc041718c7041d39b736a696887cc87/image1.png](VLAN的跳跃攻击（VLAN%20“Hopping”）/image1.png)

图四

首先大家要对VLAN有个认识，VLAN是一种应用在广域网和局域网中的一种虚拟网络技术，个人感觉其在局域网应用最为广泛，使用VLAN的优点就是能加快速度，同时由于不同VLAN间一般是不能相互访问的，这也提高了网络的安全性。VLAN间的数据都是在干道上进行传递的，而传递的前提会有一个相互协商的过程，只有两台交换机之间相互协商好了，才能互相的信任，从而传递和接受对方的数据。如图四就是一个拥有四个VLAN的网络拓扑图。

这里加入VLAN30是学校的财务处，VLAN40是学校的教务处，很明显这两个VLAN中的数据都是一些敏感的数据，通常情况下，VLAN10跟VLAN20是没法访问的，这就在一定程度上保证了数据的安全性。

**那么针对这种安全(不同VLAN间不能相互访问)，攻击者所提出的想法就是能够访问不同VLAN间的信息，从而到达窃取任何VLAN数据的目的**。**目前攻击的方法主要有两种，一种是通过协商干道来实施的，一种是通过发送双重802.1Q标记的帧来突破的，**下面就分别讲解这两种攻击的方法和怎样去防护。

1、通过协商干道的方式来攻击

上面说过，只有在干道上才能传递不同VLAN的数据信息，如图四，SW1跟SW2之间的链路就会被协商为一条干道，干道的协商是通过对方互相发送DTP帧来实现的，这样就给了攻击者入侵的“把柄”，如果此时VLAN10中的用户拿一台交换机接在端口上，在链路之间没有安全配置的情况下，通过发送恶意的DTP帧，跟上层交换机相互协商，使其之间的链路成为干道链路，这样就可以访问VLAN30的数据了。对于这种攻击的防护比较简单，我们通过Sw mode access这条命令将所有接入端口设置成接入模式就可以了，关闭其干道功能，因为下面所接的都是些终端设备，没有必要让其传递VLAN信息。

switchport mode access

switchport access vlan XXX

sw mo tr

sw tr en

2、发送双重802.1Q标记的帧来实施攻击

要想了解这种攻击必须先了解一个概念，那就是本征vlan不打标签，当数据经过第一个交换机时会自动把帧中的标签去掉，还有这种攻击有个前提：连接攻击者的交换机的端口所在VLAN必须和交换机之间的native VLAN相同。下面我通过图五来讲解一下这种攻击。

![VLAN%E7%9A%84%E8%B7%B3%E8%B7%83%E6%94%BB%E5%87%BB%EF%BC%88VLAN%20%E2%80%9CHopping%E2%80%9D%EF%BC%89%202dc041718c7041d39b736a696887cc87/image2.png](VLAN的跳跃攻击（VLAN%20“Hopping”）/image2.png)

R1跟SW1之间是native vlan

图五

R1被视为攻击者，当R1通过修改伪造等手段把数据包修改为802.1Q（vlan10）|802.1Q（vlan20）发往SW1，当SW1收到这个包之后会将其头部的标签802.1Q去掉并允许其在vlan10中传播，这样就只剩下802.1Q（vlan20），然后把这个信息传递给SW2，SW2收到后也把802.1Q这个标签去掉，这样剩下的信息就可以在vlan20中传递了，这样就可以访问vlan20，达到了入侵的目的。解决这种攻击的方法有两种，一种是将native vlan设置成没有用户存在的vlan，也就是说将图五中R1的VLAN设置成别的，总之使其这个vlan跟R1所在的vlan不同就可以了。另一种是通过输入Vlan dot1q tag native这条命令，使得所有的native vlan都打上标签，这样也就不会去掉帧中的标签了。

> 
> 

两种封装形势ISL协议和802.1Q的区别在于针对native vlan是否打标. ISL是全部都打,有几个VLAN打几个标记,而802.1Q协议除了VLAN1也就是native vlan不打标记之外其他的VLAN都打标记,作用都是一样的,都能让TRUNK识别不同的VLAN. 那为什么不对VLAN1打标记呢.就是因为VLAN1中承载着许多信息.对native vlan标记是相当不利的.

对于trunk和native vlan的最佳部署规则

1.将所有未使用的端口shutdown掉，并将它们放入到一个未使用的VLAN中，默认是vlan 1

2.不要使用VLAN 1做任何事情

3.拒绝trunk的自动协商，手工配置trunk，关闭DTP

4.强制native vlan打tag，命令：vlan dot1q tag native